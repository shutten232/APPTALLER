<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Carga Taller GNC · Quirgroup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      /* Marca */
      --amarillo:#ffd600;
      --rojo:#e3000b;
      --azul:#003a70;

      /* Neutros dark */
      --fondo:#020617;
      --card:#0b1120;
      --borde:#1f2937;
      --texto:#e5e7eb;
      --texto-suave:#9ca3af;
    }

    *{
      box-sizing:border-box;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    body{
      margin:0;
      padding:10px;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      background:var(--fondo);
      color:var(--texto);
      font-size:16px;
    }

    /* INTRO SOLO LOGO */
    .splash-overlay{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at 10% 0%, #0b1935 0, #020617 45%, #000000 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999;
      transition:opacity .6s ease, transform .6s ease, visibility .6s ease;
    }

    .splash-overlay.splash-hidden{
      opacity:0;
      visibility:hidden;
      transform:scale(1.03);
      pointer-events:none;
    }

    .splash-logo{
      animation:logoFloat 1.8s ease-in-out infinite alternate;
    }

    .marca-splash{
      display:inline-flex;
      align-items:center;
      padding:5px 16px 6px;
      border-radius:999px;
      background:var(--amarillo);
      box-shadow:0 0 0 2px rgba(0,0,0,.4), 0 10px 24px rgba(0,0,0,.9);
      transform:scale(1.15);
    }

    .marca-splash span.quir{
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.1em;
      font-size:14px;
      color:var(--rojo);
      margin-right:4px;
    }

    .marca-splash span.group{
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.08em;
      font-size:13px;
      color:#111111;
    }

    .marca-splash span.gnc-pill{
      margin-left:6px;
      padding:2px 8px 3px;
      border-radius:999px;
      background:var(--azul);
      color:var(--amarillo);
      font-weight:700;
      font-size:11px;
      letter-spacing:.16em;
    }

    @keyframes logoFloat{
      from{ transform:translateY(0) scale(1.15); }
      to{ transform:translateY(-4px) scale(1.2); }
    }

    /* APP PRINCIPAL */

    .app{
      width:100%;
      max-width:480px;
      background:var(--card);
      border-radius:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.5);
      padding:14px 14px 18px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:4px 0 10px;
      border-bottom:1px solid var(--borde);
      margin-bottom:6px;
    }

    .marca{
      display:inline-flex;
      align-items:center;
      padding:3px 12px 4px;
      border-radius:999px;
      background:var(--amarillo);
      box-shadow:0 0 0 1px rgba(0,0,0,.5);
    }

    .marca span.quir{
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.06em;
      font-size:12px;
      color:var(--rojo);
      margin-right:3px;
    }

    .marca span.group{
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.05em;
      font-size:11px;
      color:#111111;
    }

    .marca span.gnc-pill{
      margin-left:6px;
      padding:1px 6px 2px;
      border-radius:999px;
      background:var(--azul);
      color:var(--amarillo);
      font-weight:700;
      font-size:10px;
      letter-spacing:.12em;
    }

    .topbar-titulos{
      text-align:right;
      margin-left:12px;
      flex:1;
    }

    .topbar-titulos h1{
      font-size:16px;
      margin:0;
      font-weight:700;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--amarillo);
    }

    .subfecha{
      font-size:12px;
      color:var(--texto-suave);
      margin:2px 0 0;
    }

    /* Modo pestañas: Hoy / Archivado */

    .mode-tabs{
      margin-top:10px;
      display:flex;
      background:#020617;
      border-radius:999px;
      padding:3px;
      border:1px solid var(--borde);
    }

    .mode-tab{
      flex:1;
      border:none;
      border-radius:999px;
      padding:6px 0;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      background:transparent;
      color:var(--texto-suave);
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .mode-tab.activa{
      background:var(--azul);
      color:#ffffff;
      box-shadow:0 2px 6px rgba(0,0,0,.5);
    }

    /* Tabs talleres (solo modo "Hoy") */

    .tabs{
      margin:12px 0;
      display:flex;
      background:#020617;
      border-radius:999px;
      padding:4px;
      border:1px solid var(--borde);
    }

    .tab{
      flex:1;
      border:none;
      border-radius:999px;
      padding:8px 0;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      background:transparent;
      color:var(--texto-suave);
      transition:.15s;
      white-space:nowrap;
    }

    .tab.activa{
      background:var(--azul);
      color:#ffffff;
      box-shadow:0 2px 6px rgba(0,0,0,.5);
    }

    .panel{
      border-radius:16px;
      border:1px solid var(--borde);
      padding:12px 12px 14px;
      margin-bottom:12px;
      background:#020617;
    }

    .panel-titulo{
      font-size:14px;
      font-weight:600;
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--amarillo);
    }

    .resumen-linea{
      font-size:13px;
      margin:0;
      color:var(--texto-suave);
    }

    .resumen-linea span{
      font-weight:600;
      color:var(--texto);
    }

    .ultima-actualizacion{
      margin-top:4px;
      font-size:11px;
      color:var(--texto-suave);
    }

    .grupo-campos{
      margin-top:10px;
    }

    .campo{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
      gap:6px;
    }

    .campo-label{
      font-size:14px;
      flex:1.1;
    }

    .campo-controles{
      display:flex;
      align-items:center;
      gap:4px;
      flex:1;
      justify-content:flex-end;
    }

    .campo-controles button{
      width:36px;
      height:36px;
      border-radius:10px;
      border:1px solid var(--borde);
      background:#020617;
      font-size:18px;
      line-height:1;
      cursor:pointer;
      color:var(--amarillo);
      box-shadow:0 1px 3px rgba(0,0,0,.6);
    }

    .campo-controles button:active{
      transform:translateY(1px);
      box-shadow:0 1px 1px rgba(0,0,0,.8);
    }

    .campo-controles input{
      width:70px;
      text-align:center;
      padding:5px 6px;
      border-radius:10px;
      border:1px solid var(--borde);
      font-size:14px;
      background:#020617;
      color:var(--texto);
    }

    .campo-texto{
      display:flex;
      flex-direction:column;
      margin-top:10px;
    }

    .campo-texto .campo-label{
      font-size:13px;
      color:var(--texto-suave);
    }

    .campo-texto textarea{
      margin-top:6px;
      width:100%;
      border-radius:12px;
      border:1px solid var(--borde);
      padding:8px 10px;
      font-size:14px;
      resize:vertical;
      min-height:140px;
      background:#020617;
      color:var(--texto);
    }

    .campo-texto textarea::placeholder{
      color:#6b7280;
    }

    .btn-guardar{
      width:100%;
      margin-top:12px;
      padding:10px 0;
      border:none;
      border-radius:999px;
      background:linear-gradient(90deg,var(--amarillo),#fbbf24);
      color:#111827;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.7);
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .btn-guardar:active{
      transform:translateY(1px);
      box-shadow:0 2px 6px rgba(0,0,0,.9);
    }

    .btn-cerrar-dia{
      width:100%;
      margin-top:8px;
      padding:8px 0;
      border-radius:999px;
      border:1px solid #facc15;
      background:transparent;
      color:#facc15;
      font-size:12px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.08em;
      cursor:pointer;
    }

    .btn-cerrar-dia:active{
      transform:translateY(1px);
      box-shadow:0 1px 3px rgba(0,0,0,.8);
    }

    .comparacion{
      margin-top:8px;
      border-radius:16px;
      border:1px solid var(--borde);
      padding:10px 12px;
      background:#020617;
    }

    .comparacion-titulo{
      font-size:13px;
      font-weight:600;
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--amarillo);
    }

    .comparacion-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      font-size:12px;
    }

    .comparacion-col{
      background:#020617;
      border-radius:12px;
      padding:6px 8px;
      border:1px solid var(--borde);
    }

    .comparacion-col h3{
      margin:0 0 2px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.05em;
      color:var(--azul);
    }

    .comparacion-col p{
      margin:0;
      color:var(--texto-suave);
    }

    .alerta{
      margin-top:8px;
      font-size:12px;
      padding:7px 8px;
      border-radius:12px;
      background:rgba(250,204,21,0.08);
      border:1px solid #facc15;
      color:#facc15;
    }

    .alerta strong{
      color:#fde68a;
    }

    /* Panel archivos */

    .archivos-lista{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:220px;
      overflow-y:auto;
    }

    .archivo-item{
      border-radius:12px;
      border:1px solid #1f2937;
      padding:8px 10px;
      background:#020617;
      font-size:12px;
    }

    .archivo-fecha{
      font-weight:600;
      color:var(--amarillo);
      font-size:12px;
      margin-bottom:4px;
    }

    .archivo-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:6px;
    }

    .archivo-col{
      border-radius:8px;
      border:1px solid #111827;
      padding:5px 6px;
      background:#020617;
    }

    .archivo-taller{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--azul);
      margin-bottom:2px;
    }

    .archivo-linea{
      margin:0;
      color:var(--texto-suave);
      font-size:11px;
    }

    .archivo-obs{
      margin:2px 0 0;
      color:#9ca3af;
      font-size:11px;
    }

    .archivo-cierre{
      margin-top:4px;
      font-size:11px;
      color:#6b7280;
    }

    .archivo-resumen{
      margin-top:4px;
      font-size:11px;
      color:#9ca3af;
    }

    .btn-imprimir{
      width:100%;
      margin-top:8px;
      padding:8px 0;
      border-radius:999px;
      border:1px solid var(--borde);
      background:#020617;
      color:var(--texto);
      font-size:12px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.08em;
      cursor:pointer;
    }

    .btn-imprimir:active{
      transform:translateY(1px);
      box-shadow:0 1px 3px rgba(0,0,0,.8);
    }

    /* Selector de mes: columna */
    .print-mes{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .print-mes-label{
      font-size:11px;
      color:var(--texto-suave);
      text-transform:uppercase;
      letter-spacing:.06em;
    }

    .print-mes select{
      border-radius:999px;
      border:1px solid var(--borde);
      background:#020617;
      color:#e5e7eb;
      padding:8px 12px;
      font-size:12px;
      width:100%;
    }

    /* Área de impresión últimos 7 días / mes */
    .print-area{
      display:none;
      margin-top:10px;
      font-size:12px;
      color:#000000;
      background:#ffffff;
      padding:0;
    }

    .print-dia{
      margin-bottom:12px;
      padding-bottom:6px;
      border-bottom:1px solid #888;
    }

    .print-fecha{
      font-weight:700;
      margin-bottom:4px;
    }

    .print-taller{
      font-weight:600;
      margin-top:2px;
    }

    .print-linea{
      margin:0;
    }

    /* Modo impresión */
    @media print{
      body{
        margin:0;
        padding:0;
        background:#ffffff;
        color:#000000;
      }
      .splash-overlay{
        display:none !important;
      }
      .topbar,
      .mode-tabs,
      #panel-hoy{
        display:none !important;
      }
      .app{
        max-width:100%;
        box-shadow:none;
        border-radius:0;
        padding:10px;
      }
      #panel-archivos{
        border:none;
        background:#ffffff;
        box-shadow:none;
      }
      #archivos-contenido,
      #resumen-mes,
      .btn-imprimir,
      .print-mes{
        display:none !important;
      }
      .print-area{
        display:block !important;
      }
    }
  </style>

  <!-- SDK Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
</head>
<body>
  <!-- INTRO SOLO LOGO -->
  <div class="splash-overlay" id="splash">
    <div class="splash-logo">
      <div class="marca-splash">
        <span class="quir">QUIR</span>
        <span class="group">GROUP</span>
        <span class="gnc-pill">GNC</span>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="app">
    <div class="topbar">
      <div class="marca">
        <span class="quir">QUIR</span>
        <span class="group">GROUP</span>
        <span class="gnc-pill">GNC</span>
      </div>
      <div class="topbar-titulos">
        <h1>Carga Taller</h1>
        <div class="subfecha" id="subfecha"></div>
      </div>
    </div>

    <!-- Pestañas de modo: Hoy / Archivado -->
    <div class="mode-tabs">
      <button class="mode-tab activa" data-modo="hoy">Hoy</button>
      <button class="mode-tab" data-modo="archivos">Archivado</button>
    </div>

    <!-- MODO HOY -->
    <div id="panel-hoy">
      <div class="tabs">
        <button class="tab activa" data-taller="zipoli">Zipoli</button>
        <button class="tab" data-taller="alem">Alem</button>
      </div>

      <div class="panel" id="panel-taller">
        <div class="panel-titulo" id="titulo-taller">Taller Zipoli – Hoy</div>
        <p class="resumen-linea">
          <span id="resumen-dia"></span>
        </p>
        <div class="ultima-actualizacion" id="ultima-actualizacion">
          Sin registrar todavía
        </div>

        <div class="grupo-campos">
          <div class="campo">
            <div class="campo-label">Personal en el taller</div>
            <div class="campo-controles">
              <button data-op="-" data-campo="personal">−</button>
              <input type="number" id="inp-personal" min="0" step="1">
              <button data-op="+" data-campo="personal">+</button>
            </div>
          </div>

          <div class="campo">
            <div class="campo-label">Services GNC</div>
            <div class="campo-controles">
              <button data-op="-" data-campo="services">−</button>
              <input type="number" id="inp-services" min="0" step="1">
              <button data-op="+" data-campo="services">+</button>
            </div>
          </div>

          <div class="campo">
            <div class="campo-label">Pruebas hidráulicas</div>
            <div class="campo-controles">
              <button data-op="-" data-campo="pruebas">−</button>
              <input type="number" id="inp-pruebas" min="0" step="1">
              <button data-op="+" data-campo="pruebas">+</button>
            </div>
          </div>

          <div class="campo">
            <div class="campo-label">Instalaciones</div>
            <div class="campo-controles">
              <button data-op="-" data-campo="instalaciones">−</button>
              <input type="number" id="inp-instalaciones" min="0" step="1">
              <button data-op="+" data-campo="instalaciones">+</button>
            </div>
          </div>

          <div class="campo">
            <div class="campo-label">Obleas</div>
            <div class="campo-controles">
              <button data-op="-" data-campo="otros">−</button>
              <input type="number" id="inp-otros" min="0" step="1">
              <button data-op="+" data-campo="otros">+</button>
            </div>
          </div>

          <div class="campo-texto">
            <div class="campo-label">Observaciones (pruebas, instalaciones, etc.)</div>
            <textarea id="inp-observaciones" placeholder="Ej: 2 pruebas demoradas, 1 instalación grande, falta personal turno tarde..."></textarea>
          </div>
        </div>

        <button class="btn-guardar" id="btn-guardar">Guardar</button>
        <button class="btn-cerrar-dia" id="btn-cerrar-dia">Archivar taller actual</button>
      </div>

      <div class="comparacion">
        <div class="comparacion-titulo">Carga del día Zipoli vs Alem</div>
        <div class="comparacion-grid">
          <div class="comparacion-col">
            <h3>Zipoli</h3>
            <p id="cmp-zipoli">Sin datos</p>
          </div>
          <div class="comparacion-col">
            <h3>Alem</h3>
            <p id="cmp-alem">Sin datos</p>
          </div>
        </div>
        <div class="alerta" id="alerta">
          Todavía no cargaron nada hoy en ninguno de los dos talleres.
        </div>
      </div>
    </div>

    <!-- MODO ARCHIVADO -->
    <div class="panel" id="panel-archivos" style="display:none;">
      <div class="panel-titulo">Historial archivado (últimos días)</div>
      <div id="resumen-mes" class="archivo-resumen">
        Sin datos archivados de este mes todavía.
      </div>

      <button class="btn-imprimir" id="btn-imprimir-7">Imprimir últimos 7 días</button>

      <div class="print-mes">
        <div class="print-mes-label">Imprimir por mes (Zipoli + Alem)</div>
        <select id="sel-mes">
          <option value="">Elegí un mes con datos...</option>
        </select>
        <button class="btn-imprimir" id="btn-imprimir-mes">Imprimir mes</button>
      </div>

      <div id="archivos-contenido" class="archivos-lista">
        <p class="resumen-linea">Cargando datos archivados...</p>
      </div>

      <!-- Área oculta para impresión -->
      <div id="print-ultimos7" class="print-area"></div>
    </div>
  </div>

  <script>
    // INTRO: auto-ocultar y tap para saltar
    const splash = document.getElementById('splash');
    function ocultarSplash(){
      if(!splash.classList.contains('splash-hidden')){
        splash.classList.add('splash-hidden');
      }
    }
    setTimeout(ocultarSplash, 1800);
    splash.addEventListener('click', ocultarSplash);

    // Fecha del día
    const hoy = new Date();
    const fechaClave = hoy.toISOString().slice(0,10); // yyyy-mm-dd

    const subfecha = document.getElementById('subfecha');
    subfecha.textContent = hoy.toLocaleDateString('es-AR',{
      weekday:'long',
      day:'numeric',
      month:'short'
    });

    // --- Firebase INIT (nuevo proyecto talleres-quiroga) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDB41JaUmBKC_fwitN5S1RW33YXRYHoaWQ",
      authDomain: "talleres-quiroga.firebaseapp.com",
      databaseURL: "https://talleres-quiroga-default-rtdb.firebaseio.com",
      projectId: "talleres-quiroga",
      storageBucket: "talleres-quiroga.firebasestorage.app",
      messagingSenderId: "424445332430",
      appId: "1:424445332430:web:473a908db07ed6b8c7399f",
      measurementId: "G-DHYQ6YYR42"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const ROOT_PATH    = "cargaTaller";
    const LOG_ROOT     = "cargaTaller_logs";
    const ARCHIVE_ROOT = "cargaTaller_archivo";

    const diaRef = db.ref(ROOT_PATH + "/" + fechaClave);

    // --- Estado en memoria ---
    function baseTaller() {
      return {
        personal:0,
        services:0,
        pruebas:0,
        instalaciones:0,
        otros:0,
        obs:'',
        updated:null
      };
    }

    let datos = {
      fecha: fechaClave,
      zipoli: baseTaller(),
      alem:   baseTaller()
    };

    const tabs = document.querySelectorAll('.tab');
    let tallerActual = 'zipoli';

    const inputs = {
      personal: document.getElementById('inp-personal'),
      services: document.getElementById('inp-services'),
      pruebas: document.getElementById('inp-pruebas'),
      instalaciones: document.getElementById('inp-instalaciones'),
      otros: document.getElementById('inp-otros')
    };
    const inpObs = document.getElementById('inp-observaciones');

    const tituloTaller = document.getElementById('titulo-taller');
    const ultimaAct = document.getElementById('ultima-actualizacion');
    const resumenDia = document.getElementById('resumen-dia');

    const cmpZipoli = document.getElementById('cmp-zipoli');
    const cmpAlem = document.getElementById('cmp-alem');
    const alerta = document.getElementById('alerta');

    const panelHoy = document.getElementById('panel-hoy');
    const panelArchivos = document.getElementById('panel-archivos');
    const modeTabs = document.querySelectorAll('.mode-tab');
    const archivosCont = document.getElementById('archivos-contenido');
    const resumenMesEl = document.getElementById('resumen-mes');
    const printUltimos7 = document.getElementById('print-ultimos7');
    const btnImprimir7 = document.getElementById('btn-imprimir-7');
    const selMes = document.getElementById('sel-mes');
    const btnImprimirMes = document.getElementById('btn-imprimir-mes');

    let archivosOrdenados = [];
    let printUltimos7DefaultHtml = '';

    function nombreMes(m){
      const nombres = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
      const n = parseInt(m,10);
      if(n>=1 && n<=12) return nombres[n-1];
      return m;
    }

    function actualizarSelectorMeses(mesesArray){
      if(!selMes) return;
      selMes.innerHTML = '<option value="">Elegí un mes con datos...</option>';
      if(!mesesArray.length) return;
      mesesArray.forEach(code=>{
        const [y,m] = code.split('-');
        const label = nombreMes(m) + ' ' + y;
        const opt = document.createElement('option');
        opt.value = code;
        opt.textContent = label;
        selMes.appendChild(opt);
      });
    }

    // --- Modo: Hoy / Archivado ---
    let modoActual = 'hoy';
    modeTabs.forEach(btn=>{
      btn.addEventListener('click',()=>{
        modeTabs.forEach(b=>b.classList.remove('activa'));
        btn.classList.add('activa');
        modoActual = btn.dataset.modo;
        if(modoActual === 'hoy'){
          panelHoy.style.display = 'block';
          panelArchivos.style.display = 'none';
        }else{
          panelHoy.style.display = 'none';
          panelArchivos.style.display = 'block';
        }
      });
    });

    // --- Helpers de texto ---
    function textoTallerDetallado(d){
      const total = d.services + d.pruebas + d.instalaciones + d.otros;
      if(d.personal === 0 && total === 0){
        return 'Sin datos cargados todavía.';
      }
      return (
        d.personal + ' personas en el taller.<br>' +
        'Servicios GNC: ' + d.services + '<br>' +
        'Pruebas hidráulicas: ' + d.pruebas + '<br>' +
        'Instalaciones: ' + d.instalaciones + '<br>' +
        'Obleas: ' + d.otros + '.'
      );
    }

    // --- UI helpers ---
    function llenarFormulario() {
      const d = datos[tallerActual] || baseTaller();

      inputs.personal.value       = d.personal;
      inputs.services.value       = d.services;
      inputs.pruebas.value        = d.pruebas;
      inputs.instalaciones.value  = d.instalaciones;
      inputs.otros.value          = d.otros;
      inpObs.value                = d.obs || '';

      resumenDia.innerHTML = textoTallerDetallado(d);
      tituloTaller.textContent = 'Taller ' + (tallerActual === 'zipoli' ? 'Zipoli' : 'Alem') + ' – Hoy';

      if(d.updated){
        ultimaAct.textContent = 'Última actualización: ' + d.updated;
      }else{
        ultimaAct.textContent = 'Sin registrar todavía';
      }
    }

    function actualizarComparacion() {
      const dz = datos.zipoli || baseTaller();
      const da = datos.alem   || baseTaller();

      cmpZipoli.innerHTML = textoTallerDetallado(dz);
      cmpAlem.innerHTML   = textoTallerDetallado(da);

      const tz = dz.services + dz.pruebas + dz.instalaciones + dz.otros;
      const ta = da.services + da.pruebas + da.instalaciones + da.otros;

      if(tz === 0 && ta === 0){
        alerta.textContent = 'Todavía no cargaron nada hoy en ninguno de los dos talleres.';
      }else if(tz > ta){
        alerta.innerHTML = '<strong>Más cargado hoy: Zipoli.</strong> Podría convenir mandar alguien desde Alem.';
      }else if(ta > tz){
        alerta.innerHTML = '<strong>Más cargado hoy: Alem.</strong> Podría convenir mandar alguien desde Zipoli.';
      }else{
        alerta.textContent = 'Carga parecida en los dos talleres. Vean entre encargados si hace falta mover gente.';
      }
    }

    // --- Render archivos detallado, y preparar impresión ---
    function renderArchivos(snapshot){
      if(!archivosCont) return;
      if(!snapshot.exists()){
        archivosCont.innerHTML = '<p class="resumen-linea">No hay días archivados todavía.</p>';
        if(resumenMesEl) resumenMesEl.textContent = 'Sin datos archivados de este mes todavía.';
        if(printUltimos7){
          printUltimos7DefaultHtml = '<p>No hay datos para imprimir.</p>';
          printUltimos7.innerHTML = printUltimos7DefaultHtml;
        }
        archivosOrdenados = [];
        actualizarSelectorMeses([]);
        return;
      }

      const items = [];
      snapshot.forEach(child=>{
        items.push({ key: child.key, val: child.val() });
      });

      // ordenar por fecha descendente (más nuevo primero)
      items.sort((a,b)=> b.key.localeCompare(a.key));
      archivosOrdenados = items;

      const ahora = new Date();
      const currentYear  = String(ahora.getFullYear());
      const currentMonth = String(ahora.getMonth()+1).padStart(2,'0');

      const acumulado = {
        zipoli:{services:0, pruebas:0, instalaciones:0, otros:0, totalTrabajos:0},
        alem:  {services:0, pruebas:0, instalaciones:0, otros:0, totalTrabajos:0}
      };

      let html = '';
      let printHtml7 = '';
      const mesesSet = new Set();

      items.forEach((item, idx)=>{
        const fecha = item.key;
        const d = item.val || {};
        const z = d.zipoli || null;
        const a = d.alem   || null;

        const tz = z ? (z.services + z.pruebas + z.instalaciones + z.otros) : 0;
        const ta = a ? (a.services + a.pruebas + a.instalaciones + a.otros) : 0;

        const cz = z && z.cerradoA ? z.cerradoA : '-';
        const ca = a && a.cerradoA ? a.cerradoA : '-';

        const obsZ = z && z.obs ? z.obs : 'Sin observaciones.';
        const obsA = a && a.obs ? a.obs : 'Sin observaciones.';

        const partesFecha = fecha.split('-');
        if(partesFecha.length === 3){
          const [y,m] = partesFecha;
          mesesSet.add(y + '-' + m);
          const esMesActual = (y === currentYear && m === currentMonth);
          if(esMesActual){
            if(z){
              acumulado.zipoli.services      += z.services || 0;
              acumulado.zipoli.pruebas       += z.pruebas || 0;
              acumulado.zipoli.instalaciones += z.instalaciones || 0;
              acumulado.zipoli.otros         += z.otros || 0;
              acumulado.zipoli.totalTrabajos += tz;
            }
            if(a){
              acumulado.alem.services        += a.services || 0;
              acumulado.alem.pruebas         += a.pruebas || 0;
              acumulado.alem.instalaciones   += a.instalaciones || 0;
              acumulado.alem.otros           += a.otros || 0;
              acumulado.alem.totalTrabajos   += ta;
            }
          }
        }

        // HTML en pantalla
        html += `
          <div class="archivo-item">
            <div class="archivo-fecha">${fecha}</div>
            <div class="archivo-grid">
              <div class="archivo-col">
                <div class="archivo-taller">Zipoli</div>
                ${z ? `
                  <p class="archivo-linea">Personas en el taller: ${z.personal}</p>
                  <p class="archivo-linea">Servicios GNC: ${z.services}</p>
                  <p class="archivo-linea">Pruebas hidráulicas: ${z.pruebas}</p>
                  <p class="archivo-linea">Instalaciones: ${z.instalaciones}</p>
                  <p class="archivo-linea">Obleas: ${z.otros}</p>
                  <p class="archivo-obs">Observaciones: ${obsZ}</p>
                  <div class="archivo-cierre">Cierre Zipoli: ${cz}</div>
                ` : `
                  <p class="archivo-linea">Sin datos archivados para Zipoli ese día.</p>
                `}
              </div>
              <div class="archivo-col">
                <div class="archivo-taller">Alem</div>
                ${a ? `
                  <p class="archivo-linea">Personas en el taller: ${a.personal}</p>
                  <p class="archivo-linea">Servicios GNC: ${a.services}</p>
                  <p class="archivo-linea">Pruebas hidráulicas: ${a.pruebas}</p>
                  <p class="archivo-linea">Instalaciones: ${a.instalaciones}</p>
                  <p class="archivo-linea">Obleas: ${a.otros}</p>
                  <p class="archivo-obs">Observaciones: ${obsA}</p>
                  <div class="archivo-cierre">Cierre Alem: ${ca}</div>
                ` : `
                  <p class="archivo-linea">Sin datos archivados para Alem ese día.</p>
                `}
              </div>
            </div>
          </div>
        `;

        // HTML para impresión de los últimos 7 días cargados
        if(idx < 7){
          printHtml7 += `
            <div class="print-dia">
              <div class="print-fecha">${fecha}</div>
              <div class="print-taller">Taller Zipoli</div>
              ${z ? `
                <p class="print-linea">Personas en el taller: ${z.personal}</p>
                <p class="print-linea">Servicios GNC: ${z.services}</p>
                <p class="print-linea">Pruebas hidráulicas: ${z.pruebas}</p>
                <p class="print-linea">Instalaciones: ${z.instalaciones}</p>
                <p class="print-linea">Obleas: ${z.otros}</p>
                <p class="print-linea">Observaciones: ${obsZ}</p>
              ` : `
                <p class="print-linea">Sin datos para Zipoli ese día.</p>
              `}
              <div class="print-taller">Taller Alem</div>
              ${a ? `
                <p class="print-linea">Personas en el taller: ${a.personal}</p>
                <p class="print-linea">Servicios GNC: ${a.services}</p>
                <p class="print-linea">Pruebas hidráulicas: ${a.pruebas}</p>
                <p class="print-linea">Instalaciones: ${a.instalaciones}</p>
                <p class="print-linea">Obleas: ${a.otros}</p>
                <p class="print-linea">Observaciones: ${obsA}</p>
              ` : `
                <p class="print-linea">Sin datos para Alem ese día.</p>
              `}
            </div>
          `;
        }
      });

      archivosCont.innerHTML = html;

      // resumen mensual separado por taller
      if(resumenMesEl){
        const z = acumulado.zipoli;
        const a = acumulado.alem;
        if(z.totalTrabajos === 0 && a.totalTrabajos === 0){
          resumenMesEl.textContent = 'Sin datos archivados de este mes todavía.';
        }else{
          resumenMesEl.innerHTML =
            'Resumen mes actual<br>' +
            'Zipoli — Servicios GNC: ' + z.services +
            ' · Pruebas hidráulicas: ' + z.pruebas +
            ' · Instalaciones: ' + z.instalaciones +
            ' · Obleas: ' + z.otros + '<br>' +
            'Alem — Servicios GNC: ' + a.services +
            ' · Pruebas hidráulicas: ' + a.pruebas +
            ' · Instalaciones: ' + a.instalaciones +
            ' · Obleas: ' + a.otros;
        }
      }

      // setear HTML por defecto para "últimos 7 días"
      if(printUltimos7){
        if(printHtml7.trim() === ''){
          printUltimos7DefaultHtml = '<p>No hay datos para imprimir.</p>';
        }else{
          printUltimos7DefaultHtml = `
            <div style="font-weight:700;margin-bottom:8px;">
              Informe últimos 7 días cargados – Zipoli y Alem
            </div>
            ${printHtml7}
          `;
        }
        printUltimos7.innerHTML = printUltimos7DefaultHtml;
      }

      // actualizar selector de meses disponibles
      const mesesOrdenados = Array.from(mesesSet).sort((a,b)=> b.localeCompare(a)); // más nuevo arriba
      actualizarSelectorMeses(mesesOrdenados);
    }

    // --- Listeners Realtime día actual ---
    function initRealtime() {
      ['zipoli','alem'].forEach(taller => {
        diaRef.child(taller).on('value', snap => {
          const val = snap.val();
          if(val){
            datos[taller] = Object.assign(baseTaller(), val);
          }else{
            datos[taller] = baseTaller();
          }
          if(taller === tallerActual){
            llenarFormulario();
          }
          actualizarComparacion();
        });
      });
    }

    // --- Listener archivos (últimos ~40 días para cubrir el mes) ---
    function initArchivos(){
      const archivosQuery = db.ref(ARCHIVE_ROOT)
                             .orderByKey()
                             .limitToLast(40);
      archivosQuery.on('value', renderArchivos);
    }

    initRealtime();
    initArchivos();

    // --- Tabs talleres ---
    tabs.forEach(tab=>{
      tab.addEventListener('click',()=>{
        tabs.forEach(t=>t.classList.remove('activa'));
        tab.classList.add('activa');
        tallerActual = tab.dataset.taller;
        llenarFormulario();
        actualizarComparacion();
      });
    });

    // --- Botones +/- ---
    document.getElementById('panel-taller')
      .addEventListener('click',(e)=>{
        const btn = e.target;
        if(btn.tagName !== 'BUTTON') return;
        const op = btn.dataset.op;
        const campo = btn.dataset.campo;
        if(!op || !campo) return;
        const input = inputs[campo];
        let val = parseInt(input.value || '0',10);
        if(op === '+') val++;
        if(op === '-' && val>0) val--;
        input.value = val;
      });

    // --- Guardar en Realtime + log (independiente por taller) ---
    document.getElementById('btn-guardar')
      .addEventListener('click',()=>{
        const d = datos[tallerActual];

        d.personal      = parseInt(inputs.personal.value      || '0',10);
        d.services      = parseInt(inputs.services.value      || '0',10);
        d.pruebas       = parseInt(inputs.pruebas.value       || '0',10);
        d.instalaciones = parseInt(inputs.instalaciones.value || '0',10);
        d.otros         = parseInt(inputs.otros.value         || '0',10);
        d.obs           = inpObs.value.trim();
        d.updated       = new Date().toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'});

        const payload = {
          personal: d.personal,
          services: d.services,
          pruebas: d.pruebas,
          instalaciones: d.instalaciones,
          otros: d.otros,
          obs: d.obs,
          updated: d.updated
        };

        const logRef = db.ref(LOG_ROOT + "/" + fechaClave + "/" + tallerActual);
        const logData = Object.assign({ ts: firebase.database.ServerValue.TIMESTAMP }, payload);

        diaRef.child(tallerActual).set(payload)
          .then(()=>{
            return logRef.push(logData);
          })
          .catch(err=>{
            console.error(err);
            alert('Error al guardar en la base de datos: ' + err.message);
          });
      });

    // --- Archivar taller actual y reiniciar solo ese taller ---
    document.getElementById('btn-cerrar-dia')
      .addEventListener('click',()=>{
        const nombreTaller = (tallerActual === 'zipoli') ? 'Zipoli' : 'Alem';
        if(!confirm('¿Archivar y reiniciar hoy el taller ' + nombreTaller + '?')) return;

        const d = datos[tallerActual] || baseTaller();
        const total = d.services + d.pruebas + d.instalaciones + d.otros;
        const cerradoA = new Date().toLocaleString('es-AR');

        const archivePayload = {
          personal: d.personal,
          services: d.services,
          pruebas: d.pruebas,
          instalaciones: d.instalaciones,
          otros: d.otros,
          obs: d.obs || '',
          updated: d.updated || null,
          totalTrabajos: total,
          cerradoA: cerradoA
        };

        const archiveRef = db.ref(ARCHIVE_ROOT + "/" + fechaClave + "/" + tallerActual);

        archiveRef.set(archivePayload)
          .then(()=>{
            return diaRef.child(tallerActual).set(baseTaller());
          })
          .then(()=>{
            datos[tallerActual] = baseTaller();
            llenarFormulario();
            actualizarComparacion();
            alert('Taller ' + nombreTaller + ' archivado y reiniciado.');
          })
          .catch(err=>{
            console.error(err);
            alert('Error al archivar: ' + err.message);
          });
      });

    // --- Botón imprimir últimos 7 días ---
    if(btnImprimir7){
      btnImprimir7.addEventListener('click',()=>{
        if(printUltimos7){
          printUltimos7.innerHTML = printUltimos7DefaultHtml || '<p>No hay datos para imprimir.</p>';
        }
        window.print();
      });
    }

    // --- Botón imprimir mes seleccionado ---
    if(btnImprimirMes){
      btnImprimirMes.addEventListener('click',()=>{
        const mes = selMes.value; // formato YYYY-MM
        if(!mes){
          alert('Elegí un mes del listado.');
          return;
        }
        if(!archivosOrdenados.length){
          alert('No hay datos archivados.');
          return;
        }

        const itemsAsc = archivosOrdenados.slice().sort((a,b)=>a.key.localeCompare(b.key));
        let html = '';
        let encontrado = false;

        itemsAsc.forEach(item=>{
          if(item.key.startsWith(mes + '-')){
            encontrado = true;
            const fecha = item.key;
            const d = item.val || {};
            const z = d.zipoli || null;
            const a = d.alem   || null;
            const obsZ = z && z.obs ? z.obs : 'Sin observaciones.';
            const obsA = a && a.obs ? a.obs : 'Sin observaciones.';

            html += `
              <div class="print-dia">
                <div class="print-fecha">${fecha}</div>
                <div class="print-taller">Taller Zipoli</div>
                ${z ? `
                  <p class="print-linea">Personas en el taller: ${z.personal}</p>
                  <p class="print-linea">Servicios GNC: ${z.services}</p>
                  <p class="print-linea">Pruebas hidráulicas: ${z.pruebas}</p>
                  <p class="print-linea">Instalaciones: ${z.instalaciones}</p>
                  <p class="print-linea">Obleas: ${z.otros}</p>
                  <p class="print-linea">Observaciones: ${obsZ}</p>
                ` : `
                  <p class="print-linea">Sin datos para Zipoli ese día.</p>
                `}
                <div class="print-taller">Taller Alem</div>
                ${a ? `
                  <p class="print-linea">Personas en el taller: ${a.personal}</p>
                  <p class="print-linea">Servicios GNC: ${a.services}</p>
                  <p class="print-linea">Pruebas hidráulicas: ${a.pruebas}</p>
                  <p class="print-linea">Instalaciones: ${a.instalaciones}</p>
                  <p class="print-linea">Obleas: ${a.otros}</p>
                  <p class="print-linea">Observaciones: ${obsA}</p>
                ` : `
                  <p class="print-linea">Sin datos para Alem ese día.</p>
                `}
              </div>
            `;
          }
        });

        if(!encontrado){
          alert('No hay datos archivados para ese mes.');
          if(printUltimos7){
            printUltimos7.innerHTML = printUltimos7DefaultHtml || '<p>No hay datos para imprimir.</p>';
          }
          return;
        }

        if(printUltimos7){
          const [y,m] = mes.split('-');
          const labelMes = nombreMes(m) + ' ' + y;
          printUltimos7.innerHTML = `
            <div style="font-weight:700;margin-bottom:8px;">
              Informe mes ${labelMes} – Zipoli y Alem
            </div>
            ${html}
          `;
        }
        window.print();

        // Restauro informe de 7 días para la próxima vez
        if(printUltimos7){
          printUltimos7.innerHTML = printUltimos7DefaultHtml || '<p>No hay datos para imprimir.</p>';
        }
      });
    }

    // Primera carga de la UI
    llenarFormulario();
    actualizarComparacion();
  </script>
</body>
</html>
